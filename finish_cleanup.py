#!/usr/bin/env python3
"""
–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
"""

import json
import os
from pathlib import Path

def check_file_status():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ñ–∞–π–ª–æ–≤ –∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π"""
    print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ñ–∞–π–ª–æ–≤...")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–ø–∫–∏
    questions_dir = Path('data/questions')
    if questions_dir.exists():
        files = list(questions_dir.glob('*.json'))
        print(f"üìÅ –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–ø–∫–∞: {len(files)} —Ñ–∞–π–ª–æ–≤")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è
        psycho_file = questions_dir / '–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.json'
        if psycho_file.exists():
            with open(psycho_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
            print(f"üìÑ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.json: {len(data)} –≤–æ–ø—Ä–æ—Å–æ–≤")
        else:
            print("‚ùå –§–∞–π–ª –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.json –Ω–µ –Ω–∞–π–¥–µ–Ω")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
    backup_dir = Path('data/questions_backup')
    if backup_dir.exists():
        backup_files = list(backup_dir.glob('*.json'))
        print(f"üì¶ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏: {len(backup_files)} —Ñ–∞–π–ª–æ–≤")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ñ–∞–π–ª–∞ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è
        psycho_backup = backup_dir / '–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.json'
        if psycho_backup.exists():
            with open(psycho_backup, 'r', encoding='utf-8') as f:
                data = json.load(f)
            print(f"üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è: {len(data)} –≤–æ–ø—Ä–æ—Å–æ–≤")
        else:
            print("‚ö†Ô∏è –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
    else:
        print("‚ùå –ü–∞–ø–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

def finish_psychology_cleanup():
    """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ —Ñ–∞–π–ª–∞ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.json"""
    print("\nüßπ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ —Ñ–∞–π–ª–∞ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.json...")

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–Ω –æ—á–∏—Å—Ç–∫–∏
    try:
        with open('cleanup_plan.txt', 'r', encoding='utf-8') as f:
            plan_content = f.read()

        # –ò—â–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è
        if '–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.json' in plan_content:
            print("‚úÖ –ù–∞–π–¥–µ–Ω –ø–ª–∞–Ω –æ—á–∏—Å—Ç–∫–∏ –¥–ª—è —Ñ–∞–π–ª–∞ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è")

            # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
            # –ü–æ–∫–∞ —Å–æ–∑–¥–∞–¥–∏–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
            questions_to_remove = [
                "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ç–∞–¥–∏—è —Å—Ç—Ä–µ—Å—Å–∞ –ø–æ –°–µ–ª—å–µ, –∫–æ–≥–¥–∞ –æ—Ä–≥–∞–Ω–∏–∑–º –∏—Å—Ç–æ—â–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã?",
                "–ß—Ç–æ —Ç–∞–∫–æ–µ ¬´–ø—Ä–æ–µ–∫—Ü–∏—è¬ª –∫–∞–∫ –º–µ—Ö–∞–Ω–∏–∑–º –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∑–∞—â–∏—Ç—ã?",
                "–ö—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–∞—Ç–µ–ª–µ–º –ø—Å–∏—Ö–æ–∞–Ω–∞–ª–∏–∑–∞?",
                "–ß—Ç–æ —Ç–∞–∫–æ–µ ¬´–±—É–ª–ª–∏–Ω–≥¬ª?",
                "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ø—É–ª—è—Ä–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π, –≥–¥–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —Ä–µ—à–µ–Ω–∏—è?",
                "–ß—Ç–æ —Ç–∞–∫–æ–µ ¬´–≤—ã—É—á–µ–Ω–Ω–∞—è –±–µ—Å–ø–æ–º–æ—â–Ω–æ—Å—Ç—å¬ª?",
                "–ö—Ç–æ –∞–≤—Ç–æ—Ä –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ ¬´7 –ø—Ä–∏–≤—ã—á–µ–∫ –≤—ã—Å–æ–∫–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –ª—é–¥–µ–π¬ª?",
                "–ß—Ç–æ —Ç–∞–∫–æ–µ ¬´–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞¬ª (mind map)?",
                "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è –∏ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏?",
                "–ß—Ç–æ —Ç–∞–∫–æ–µ ¬´–∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–∏¬ª?",
                "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–æ—è–∑–Ω—å –ø—É–±–ª–∏—á–Ω—ã—Ö –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π?",
                "–ß—Ç–æ —Ç–∞–∫–æ–µ ¬´—ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫—Ä–∏–∑–∏—Å¬ª?"
            ]

            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª
            file_path = Path('data/questions/–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.json')
            backup_path = Path('data/questions_backup/–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.json')

            if file_path.exists():
                # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                if not backup_path.exists():
                    print("üìã –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...")
                    with open(file_path, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                    with open(backup_path, 'w', encoding='utf-8') as f:
                        json.dump(data, f, ensure_ascii=False, indent=2)
                    print("‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞")

                # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                with open(file_path, 'r', encoding='utf-8') as f:
                    data = json.load(f)

                original_count = len(data)
                print(f"üìä –ò—Å—Ö–æ–¥–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {original_count}")

                # –§–∏–ª—å—Ç—Ä—É–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞)
                seen_questions = set()
                filtered_data = []

                for item in data:
                    if isinstance(item, dict) and 'question' in item:
                        question_text = item['question'].strip()

                        if question_text not in seen_questions:
                            filtered_data.append(item)
                            seen_questions.add(question_text)
                        # –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —É–∂–µ –±—ã–ª, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (—ç—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç)

                final_count = len(filtered_data)
                removed_count = original_count - final_count

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(filtered_data, f, ensure_ascii=False, indent=2)

                print("‚úÖ –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–∞ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.json –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
                print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: {original_count} ‚Üí {final_count} –≤–æ–ø—Ä–æ—Å–æ–≤")
                print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: {removed_count}")

                return final_count, removed_count
            else:
                print("‚ùå –§–∞–π–ª –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ.json –Ω–µ –Ω–∞–π–¥–µ–Ω")
                return 0, 0
        else:
            print("‚ùå –ü–ª–∞–Ω –æ—á–∏—Å—Ç–∫–∏ –¥–ª—è —Ñ–∞–π–ª–∞ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return 0, 0

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: {e}")
        return 0, 0

def show_final_summary():
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    print("\n" + "="*60)
    print("üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ß–ò–°–¢–ö–ò")
    print("="*60)

    questions_dir = Path('data/questions')
    backup_dir = Path('data/questions_backup')

    total_questions = 0
    total_files = 0

    if questions_dir.exists():
        for json_file in questions_dir.glob('*.json'):
            try:
                with open(json_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                total_questions += len(data)
                total_files += 1
            except:
                pass

    print(f"üìÅ –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: {total_files}")
    print(f"‚ùì –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: {total_questions}")
    print(f"üíæ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏: {backup_dir.exists()}")

    if backup_dir.exists():
        backup_files = list(backup_dir.glob('*.json'))
        print(f"üì¶ –†–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π: {len(backup_files)}")

    print("\nüéâ –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    print("üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω!")

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("üöÄ –ó–ê–í–ï–†–®–ï–ù–ò–ï –û–ß–ò–°–¢–ö–ò –î–£–ë–õ–ò–ö–ê–¢–û–í")
    print("="*50)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    check_file_status()

    # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ—á–∏—Å—Ç–∫—É —Ñ–∞–π–ª–∞ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è
    final_count, removed = finish_psychology_cleanup()

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    show_final_summary()

    print("\n‚úÖ –í–°–ï –ó–ê–î–ê–ß–ò –ü–û –û–ß–ò–°–¢–ö–ï –î–£–ë–õ–ò–ö–ê–¢–û–í –í–´–ü–û–õ–ù–ï–ù–´!")
    print("üìÑ –û—Ç—á–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞")

if __name__ == "__main__":
    main()
