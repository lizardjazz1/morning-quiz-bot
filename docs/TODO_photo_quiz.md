### ToDo roadmap: режим “Фото‑викторина” (угадай объект/животное по картинке)

- **Основное**
  - **Команда**: `/photoquiz` (старт в чате), `/photoquiz_stop` (остановить), `/photoquiz_skip` (админ пропустить), `/photoquiz_reveal` (админ показать ответ).
  - **Формат раунда**: бот шлёт `photo`, участники отвечают текстом в чат. Первое верное — засчитывается, остальным до дедлайна можно попытки с штрафом.
  - **Счёт**: +1 за верный, −0.5 за неверный (как в текущем режиме). Поддержать `correct_count` в сессии и глобальный счёт с ачивкой.

- **Данные**
  - **Папка с картинками**: `data/image_quiz/animals/` и `data/image_quiz/objects/` (вы добавите JPG/PNG).
  - **Индекс**: `data/image_quiz/index.jsonl` (по строке на карточку).
    - Пример строки:
      ```json
      {"id":"ani_001","file":"animals/lion.jpg","answers":["лев","lion"],"synonyms":["царь зверей"],"type":"animal","lang":"ru","difficulty":1,"hints":["Хищник","Африка"]}
      ```
  - Опционально: сохранять `file_id` Telegram после первого отправления для ускорения.

- **Настройки (`config/quiz_config.json`)**
  - Блок `image_quiz`:
    - `enabled: true`
    - `time_limit_sec: 45`
    - `max_attempts_per_user: 3`
    - `points_correct: 1`
    - `points_wrong: -0.5`
    - `fuzzy_match: true` (порог 85%)
    - `normalize: true` (нижний регистр, убрать пунктуацию/ё→е)

- **Хэндлеры**
  - Новый файл: `handlers/image_quiz_handler.py`
    - `cmd_photoquiz_start(update, context)` — валидация прав, запуск сессии в чате.
    - `cmd_photoquiz_stop(...)` — завершение сессии и итоговый счёт.
    - `cmd_photoquiz_skip(...)` (админ) — пропуск текущего изображения, показ ответа, следующий раунд.
    - `cmd_photoquiz_reveal(...)` (админ) — показать ответ без пропуска.
    - `on_text_answer(update, context)` — обработка входящих сообщений только когда активен раунд.
    - Цикл: выбрать неиспользованное изображение → `send_photo` → таймер → принимать ответы → засчитывать первое верное; по таймеру показать ответ и перейти к следующему/стоп.
  - Использовать `JobQueue` для таймаутов раунда и сервисных сообщений.

- **Состояние**
  - Расширить `state.BotState`:
    - `active_image_quiz_sessions[chat_id] = { current_item_id, used_ids, started_at, ends_at, per_user_attempts, solved_by_user_id, message_ids }`
  - Хранить прогресс фото‑сессии отдельно от обычной `QuizState`.

- **Скоринг**
  - Через `modules/score_manager.py`:
    - `apply_image_quiz_result(chat_id, user_id, is_correct)` — с теми же правилами очков и инкрементом `correct_count`.
  - Формат итога раунда: “Имя: C/Y | <ачивка> T”.

- **Сопоставление ответов**
  - Нормализация: тримминг, нижний регистр, удаление пунктуации, `ё→е`, простая эвристика числа.
  - Синонимы из `synonyms`.
  - Фаззи‑матчинг (например, `rapidfuzz >= 3`), порог 85–90%.
  - Опционально: поддержать `answers_regex` в карточке.

- **Админ/модерация**
  - Команды только для админов чата/владельцев бота.
  - Не логировать ответы целиком в публичные логи.

- **Логи/метрики**
  - Кол-во раундов, % угадываний, среднее время до первого верного.
  - Опционально: ежедневный “Фото‑день” по расписанию (`daily_photoquiz: true`).

- **Файлы/правки**
  - `handlers/image_quiz_handler.py` — новый.
  - Правки: `app_config.py` (регистрация команд), `bot.py` (роутинг команд и текстовых сообщений), `state.py` (модель состояния), `modules/score_manager.py` (вызывать из нового режима), `config/quiz_config.json` (новый блок `image_quiz`).
  - Скрипт индексации (опц.): `scripts/build_image_index.py` — собрать `index.jsonl` из папок c картинками.

- **Тесты**
  - Юнит: нормализация и матчинг ответов.
  - Интеграция: сценарий “фото → ответы → таймаут/верно → начисление очков”.

- **План внедрения**
  - Шаг 1: схема данных + конфиг + заглушечный индекс.
  - Шаг 2: хэндлеры команд и цикл раунда без скоринга.
  - Шаг 3: скоринг + отображение итогов.
  - Шаг 4: фаззи‑матчинг и синонимы.
  - Шаг 5: админ‑команды, метрики.
  - Шаг 6: индексация и кэш `file_id`.

- **Хранение по файлам**
  - Базовый вариант: единый `data/image_quiz/index.jsonl`.
  - Альтернатива: несколько файлов `data/image_quiz/index/*.jsonl` и объединять при загрузке (как с текстовыми вопросами). 